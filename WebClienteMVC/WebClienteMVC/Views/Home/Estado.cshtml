@{
    ViewBag.Title = "Estado del Pedido";
}

<div id="sin-pedido" class="text-center mt-5" style="display:none;">
    <h1 class="fw-bold">Sin Pedido en curso</h1>
    <img src="/Recursos/sinpedido.png" style="max-width:300px;" alt="Sin pedido" />
    <h3 class="mt-3 text-muted">No tienes pedidos activos en este momento.</h3>
    <a href="@Url.Action("Platos", "Home")" class="btn btn-primary btn-lg mt-3 shadow">Ir a la Carta</a>
</div>

<div id="contenedor-estado" class="text-center mt-5" style="display:none;">

    <h1 id="tituloEstado" class="fw-bold text-primary">Cargando estado...</h1>

    <div class="my-4">
        <img id="imagenEstado" src="" class="img-fluid" style="max-width:260px;" alt="Estado del pedido" />
    </div>

    <h3 id="mensajeEstado" class="fw-bold mt-3 text-dark"></h3>

    <div id="acciones-pedido">
        <button id="btnCancelar" class="btn btn-danger mt-3 px-4" onclick="cancelarPedido()">
            Cancelar Pedido
        </button>
    </div>

    <div id="accion-finalizar" style="display:none;">
        <button class="btn btn-success btn-lg mt-4 fw-bold shadow" onclick="finalizarCiclo()">
            ¡Recibido! Hacer nuevo pedido
        </button>
    </div>

    <div id="comentarios" class="mt-5 w-50 mx-auto card p-4 shadow-sm">
        <h4 class="fw-bold mb-3">¿Cómo va tu experiencia?</h4>

        <div id="bloque-formulario">
            <textarea id="txtComentario" class="form-control" rows="3"
                      placeholder="Escribe aquí tu comentario..."></textarea>
            <button class="btn btn-primary w-100 mt-3" onclick="guardarComentario()">
                Enviar comentario
            </button>
        </div>

        <div id="bloque-agradecimiento" class="alert alert-success mt-3 mb-0" style="display:none;">
            <h4 class="fw-bold">¡Gracias!</h4>
            <p class="m-0">Lo tendremos presente para mejorar.</p>
        </div>
    </div>
</div>

@section scripts{
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ---------------------------------------------------------
        // 1. LÓGICA DE INICIO: PRIORIDAD AL SERVIDOR
        // ---------------------------------------------------------

        // Capturamos el ID que nos manda el Controller (desde la BD)
        // El '0' es un valor por defecto en caso de que venga null
        let idVentaServer = parseInt('@(ViewBag.IdVentaActiva ?? 0)');
        let idVenta = 0;

        // Si la BD dice que hay pedido, ese manda (y actualizamos el navegador)
        if (idVentaServer > 0) {
            idVenta = idVentaServer;
            sessionStorage.setItem("ventaActual", idVenta);
            console.log("Pedido recuperado del servidor: " + idVenta);
        } else {
            // Si la BD dice que no hay nada, limpiamos la basura local
            sessionStorage.removeItem("ventaActual");
            idVenta = null;
        }

        let intervalo = null;
        let estadoAnterior = null;

        // Referencias a los elementos HTML
        const divSinPedido = document.getElementById("sin-pedido");
        const divConEstado = document.getElementById("contenedor-estado");

        // ---------------------------------------------------------
        // 2. CONTROL VISUAL (MOSTRAR U OCULTAR PANTALLAS)
        // ---------------------------------------------------------
        if (divSinPedido && divConEstado) {
            if (!idVenta) {
                // CASO A: No hay venta activa
                divSinPedido.style.display = "block";
                divConEstado.style.display = "none";
            } else {
                // CASO B: Hay venta activa
                divSinPedido.style.display = "none";
                divConEstado.style.display = "block";

                actualizarEstado(); // Ejecutar ya
                intervalo = setInterval(actualizarEstado, 5000); // Repetir
            }
        } else {
            console.error("ERROR: No se encontraron los DIVs.");
        }

        // ---------------------------------------------------------
        // 3. FUNCIÓN PRINCIPAL DE ACTUALIZACIÓN
        // ---------------------------------------------------------
        function actualizarEstado() {
            if (!idVenta) return;

            $.get("/Home/EstadoVentaJson", { id: idVenta }, function (data) {
                if (!data.ok) return;

                let estado = data.estado;

                
                //if (estadoAnterior !== null && estadoAnterior !== estado) {
                //   console.log("El estado cambió de " + estadoAnterior + " a " + estado);
                //   location.reload();
                //    return;
                //}
                estadoAnterior = estado;

                // --- LÓGICA DE ESTADOS ESPECÍFICOS ---

                // A. ESTADOS ACTIVOS (Pedido vivo)
                if (estado === "Pendiente") {
                    $("#tituloEstado").text("Pedido Recibido");
                    $("#imagenEstado").attr("src", "/Recursos/pendiente.png");
                    $("#mensajeEstado").text("Estamos validando tu pedido. " + (data.horaLista ? "Hora aprox: " + data.horaLista : ""));

                    $("#btnCancelar").show(); 
                    $("#acciones-pedido").show();
                    $("#accion-finalizar").hide();

                }
                else if (estado === "Procesando") {
                    $("#tituloEstado").text("Cocinando...");
                    $("#imagenEstado").attr("src", "/Recursos/preparando.png");
                    $("#mensajeEstado").text("El chef está preparando tus platos.");

                    $("#btnCancelar").hide();
                    $("#acciones-pedido").show();
                  
                }
                // B. ESTADO EXITOSO (Fin del ciclo)
                else if (estado === "Entregado") {
                    $("#tituloEstado").text("¡Pedido Entregado!");
                    $("#imagenEstado").attr("src", "/Recursos/Listo.png");
                    $("#mensajeEstado").text("¡Buen provecho! Tu pedido ha sido completado.");

                    $("#acciones-pedido").hide();
                    $("#accion-finalizar").show();
                    $("#accion-finalizar button").text("¡Estuvo delicioso! Pedir más");

                    if(intervalo) clearInterval(intervalo);
                }
                // C. ESTADO FALLIDO (Fin del ciclo)
                else if (estado === "Cancelado") {
                    $("#tituloEstado").text("Pedido Cancelado");
                    $("#imagenEstado").attr("src", "/Recursos/cancelado.png");
                    $("#mensajeEstado").text("Lo sentimos, este pedido fue cancelado.");

                    $("#acciones-pedido").hide();
                    $("#accion-finalizar").show();
                    $("#accion-finalizar button").text("Intentar de nuevo");

                    if(intervalo) clearInterval(intervalo);
                }

                validarComentario();
            });
        }

        // ---------------------------------------------------------
        // 4. FUNCIONES AUXILIARES
        // ---------------------------------------------------------

        function finalizarCiclo() {
            // Limpiamos todo y mandamos a la carta
            sessionStorage.removeItem("ventaActual");
            localStorage.removeItem("comentario_hecho_" + idVenta);
            window.location.href = "@Url.Action("Platos", "Home")";
        }

        function cancelarPedido() {
             Swal.fire({
                title: '¿Cancelar pedido?',
                text: "Esta acción no se puede deshacer.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, cancelar',
                cancelButtonText: 'No, esperar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "/Ventas/CancelarVenta",
                        type: "POST",
                        data: { idVenta: idVenta },
                        success: function (resp) {
                            if (resp.ok) {
                                Swal.fire(
                                    '¡Cancelado!',
                                    'Tu pedido ha sido cancelado.',
                                    'success'
                                ).then(() => {
                                    // Recargamos la página para que el script "actualizarEstado"
                                    // detecte el nuevo estado "Cancelado" y pinte la pantalla roja.
                                    location.reload();
                                });
                            } else {
                                Swal.fire('Error', resp.msg, 'error');
                            }
                        },
                        error: function () {
                            Swal.fire('Error', 'No se pudo conectar con el servidor', 'error');
                        }
                    });
                    finalizarCiclo();
                }
            });
        }

        // --- LÓGICA DE COMENTARIOS (Igual que antes) ---

        function validarComentario() {
            if (localStorage.getItem("comentario_hecho_" + idVenta)) {
                mostrarAgradecimiento();
            }
        }

        function guardarComentario() {
            let txt = $("#txtComentario").val();

            if (txt.trim() === "") {
                Swal.fire('Ups...', 'El comentario no puede estar vacío.', 'warning');
                return;
            }

            $.ajax({
                url: "/Home/GuardarComentarioBD",
                type: "POST",
                data: {
                    idVenta: idVenta,
                    texto: txt
                },
                success: function (resp) {
                    if (resp.ok) {
                        localStorage.setItem("comentario_hecho_" + idVenta, "true");
                        Swal.fire({
                            title: '¡Recibido!',
                            text: 'Gracias por ayudarnos a mejorar.',
                            icon: 'success',
                            timer: 2500,
                            showConfirmButton: false
                        });
                        mostrarAgradecimiento();
                    } else {
                        Swal.fire('Error', resp.msg, 'error');
                    }
                },
                error: function (e) {
                    Swal.fire('Error', 'No se pudo conectar con el servidor', 'error');
                }
            });
        }

        function mostrarAgradecimiento() {
            $("#bloque-formulario").hide();
            $("#bloque-agradecimiento").fadeIn();
        }
    </script>
}