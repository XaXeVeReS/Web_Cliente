@{
    Layout = null;
    string usuarioNombre = Session["Usuario"]?.ToString() ?? "Invitado";
    bool isLogged = usuarioNombre != "Invitado";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewBag.Title - La Mamacha</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
        }

        /* CABECERA */
        .header-food {
            background-image: url('/Recursos/Inicio.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 15px 10px;
            border-bottom: 3px solid #000;
        }

        .text-border {
            text-shadow: -1px -1px 0 black, 1px -1px 0 black, -1px 1px 0 black, 1px 1px 0 black;
        }

        .menu-food a {
            color: white;
            font-weight: bold;
            font-size: 22px;
            text-decoration: none;
        }

            .menu-food a:hover {
                color: yellow;
            }

        /* DROPDOWN USUARIO */
        .user-dropdown-toggle {
            cursor: pointer;
            text-decoration: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

            .user-dropdown-toggle:hover {
                opacity: 0.9;
            }

        /* PANEL IZQUIERDO (CARRITO) */
        #panelCompras {
            background: #f7f7f7;
            border-right: 3px solid #ccc;
            min-height: calc(100vh - 260px);
            overflow-y: auto;
            transition: width 0.35s ease;
            width: 400px;
            max-width: 400px;
            min-width: 55px;
        }

        .panel-collapsed {
            width: 55px !important;
            max-width: 60px !important;
            overflow: hidden;
        }

        .table-hidden, .titulo-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 20;
        }

        /* CONTENIDO PRINCIPAL */
        .main-content {
            min-height: calc(100vh - 260px);
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 250px);
            padding-right: 10px;
        }

        /* FOOTER */
        .footer-food {
            background-image: url('/Recursos/Inicio.jpg');
            background-size: cover;
            text-align: center;
            padding: 23px 0;
            border-top: 3px solid #000;
        }

            .footer-food h1 {
                color: white;
                font-size: 40px;
                font-weight: bold;
                text-shadow: -1px -1px 0 black, 1px -1px 0 black, -1px 1px 0 black, 1px 1px 0 black;
            }
    </style>
</head>
<body>

    <div class="container-fluid header-food">
        <div class="row text-center align-items-center">
            <div class="col-12 col-md-2">
                <img src="~/Recursos/fondo_web.png" class="img-fluid" style="max-height: 110px;" />
            </div>

            <div class="col-12 col-md-8">
                <h1 class="text-border fw-bold">La Mamacha</h1>
                <div class="row menu-food mt-3">
                    <div class="col">@Html.ActionLink("Plato", "Platos", "Home")</div>
                    <div class="col">@Html.ActionLink("Promociones", "Promociones", "Home")</div>
                    <div class="col">@Html.ActionLink("Estado", "Estado", "Home")</div>
                </div>
            </div>

            <div class="col-12 col-md-2 d-flex justify-content-center justify-content-md-end pe-md-4">
                <div class="dropdown">
                    <div class="user-dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="text-end me-2">
                            <h4 class="text-border m-0">@usuarioNombre</h4>
                            <small class="text-white">@(isLogged ? "Online" : "Bienvenido")</small>
                        </div>
                        <img src="/Recursos/Usuario.png" class="img-fluid rounded-circle border border-2 border-white" style="max-height: 60px; width: 60px; object-fit: cover;" />
                    </div>

                    <ul class="dropdown-menu dropdown-menu-end shadow">
                        @if (isLogged)
                        {
                            <li><h6 class="dropdown-header">Hola, @usuarioNombre</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger fw-bold" href="@Url.Action("Login", "Login")">Cerrar Sesión</a></li>
                        }
                        else
                        {
                            <li><a class="dropdown-item fw-bold" href="@Url.Action("Login", "Usuarios")">Iniciar Sesión</a></li>
                            <li><a class="dropdown-item" href="@Url.Action("Registro", "Usuarios")">Registrarse</a></li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row gx-0 d-flex">

            <div id="panelCompras" class="col-auto position-relative">
                <div id="tituloCompras" class="p-2">
                    <h4 class="fw-bold m-0">Compras</h4>
                </div>

                <button id="btnTogglePanel" class="btn btn-warning toggle-btn">☰</button>

                <div class="compras-table p-2">
                    <table class="table table-bordered tabla-compras">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Plato</th>
                                <th>Precio</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCompras"></tbody>
                    </table>
                    <h4 class="text-end fw-bold mt-2">
                        Total: <span id="totalCompras">S/ 0.00</span>
                    </h4>
                    <button class="btn btn-success w-100 mt-2 fw-bold" onclick="abrirModalPago()">
                        Proceder al Pago
                    </button>
                </div>
            </div>

            <div class="col main-content flex-grow-1">
                @RenderBody()
            </div>

        </div>
    </div>

    <div class="footer-food">
        <h1>Date un gustito, te lo mereces</h1>
    </div>

    <div class="modal fade" id="modalPago" tabindex="-1" aria-labelledby="modalPagoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="modalPagoLabel">
                        💳 Finalizar Compra
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body p-4">
                    <div class="card mb-4 border-0 bg-light">
                        <div class="card-body">
                            <h6 class="text-muted text-uppercase fw-bold mb-2 small">Resumen</h6>
                            <div class="table-responsive" style="max-height: 120px; overflow-y: auto;">
                                <table class="table table-sm table-borderless mb-0">
                                    <tbody id="tablaConfirmarPago">
                                    </tbody>
                                </table>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold text-dark">Total a Pagar</span>
                                <span class="fs-4 fw-bold text-primary" id="CostototalPagoModal">S/ 0.00</span>
                            </div>
                        </div>
                    </div>

                    <form id="formPago">
                        <h6 class="text-muted text-uppercase fw-bold mb-3 small">Método de Pago</h6>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Banco</label>
                            <select id="selectTipoTarjeta" class="form-select">
                                <option value="">Seleccione...</option>
                                <option value="BCP">BCP</option>
                                <option value="BN">Banco de la Nación</option>
                                <option value="BBVA">BBVA</option>
                                <option value="IBK">Interbank</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Número de Tarjeta</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white">💳</span>
                                <input id="txtNrtarjeta" type="text" class="form-control" placeholder="0000 0000 0000 0000" maxlength="19">
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label fw-bold small">Vencimiento (MM/YY)</label>
                                <input id="txtFechaVenc" type="text" class="form-control text-center" placeholder="MM/YY" maxlength="5">
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold small">CVV</label>
                                <div class="input-group">
                                    <input id="txtCVV" type="password" class="form-control text-center" placeholder="123" maxlength="3">
                                    <span class="input-group-text bg-white">🔒</span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="modal-footer border-0 pt-0 px-4 pb-4">
                    <button type="button" class="btn btn-outline-secondary w-100 mb-2" data-bs-dismiss="modal">Seguir comprando</button>
                    <button type="button" class="btn btn-success w-100 fw-bold py-2" onclick="validarYPagar()">
                        Pagar Ahora <span id="btnTotalLabel"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Lógica del Panel Lateral (Responsive) ---
        const panel = document.getElementById("panelCompras");
        const tabla = document.querySelector(".compras-table");
        const titulo = document.getElementById("tituloCompras");
        const btn = document.getElementById("btnTogglePanel");
        let oculto = false;

        function aplicarResponsive() {
            if (window.innerWidth < 768) {
                panel.classList.add("panel-collapsed");
                tabla.classList.add("table-hidden");
                titulo.classList.add("titulo-hidden");
                btn.classList.add("toggle-floating");
                oculto = true;
            } else {
                panel.classList.remove("panel-collapsed");
                tabla.classList.remove("table-hidden");
                titulo.classList.remove("titulo-hidden");
                oculto = false;
            }
        }
        window.addEventListener("resize", aplicarResponsive);
        aplicarResponsive();

        btn.addEventListener("click", () => {
            oculto = !oculto;
            if (oculto) {
                panel.classList.add("panel-collapsed");
                tabla.classList.add("table-hidden");
                titulo.classList.add("titulo-hidden");
                btn.classList.add("toggle-floating");
            } else {
                panel.classList.remove("panel-collapsed");
                tabla.classList.remove("table-hidden");
                titulo.classList.remove("titulo-hidden");
                btn.classList.remove("toggle-floating");
            }
        });

        // --- 2. Lógica del Carrito ---
        let compras = [];
        if (sessionStorage.getItem("carrito")) {
            compras = JSON.parse(sessionStorage.getItem("carrito"));
            actualizarTabla();
        }

        function guardarCarrito() {
            sessionStorage.setItem("carrito", JSON.stringify(compras));
        }

        function agregarACompras(id, nombre, precio, cantidad = 1) {
            let existe = compras.find(x => x.id === id && x.tipo === "plato");
            if (existe) {
                existe.cantidad += cantidad;
            } else {
                compras.push({
                    id: id, nombre: nombre, precio: precio, cantidad: cantidad,
                    descuento: null, promocion: null, tipo: "plato"
                });
            }
            guardarCarrito();
            actualizarTabla();
            Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 })
                .fire({ icon: 'success', title: 'Agregado al carrito' });
        }

        function agregarAComprasPromo(idPlato, nombre, descuento, precio, cant, idpromo) {
            let existe = compras.find(x => x.id === idPlato && x.tipo === "promo");
            if (existe) {
                existe.cantidad += 1;
            } else {
                compras.push({
                    id: idPlato, nombre: nombre, precio: precio, cantidad: cant,
                    descuento: descuento, promocion: idpromo, tipo: "promo"
                });
            }
            guardarCarrito();
            actualizarTabla();
            Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 })
                .fire({ icon: 'success', title: 'Promo agregada' });
        }

        function eliminarDelCarrito(id, tipo) {
            compras = compras.filter(p => !(p.id === id && p.tipo === tipo));
            guardarCarrito();
            actualizarTabla();
        }

        function actualizarTabla() {
            let tablaBody = document.getElementById("tablaCompras");
            let totalSpan = document.getElementById("totalCompras");
            if (!tablaBody || !totalSpan) return;

            tablaBody.innerHTML = "";
            let total = 0;

            compras.forEach(item => {
                let subtotal = item.precio * item.cantidad;
                total += subtotal;
                tablaBody.innerHTML += `
                    <tr>
                        <td>${item.cantidad}</td>
                        <td style="font-size:0.9em;">${item.tipo === "promo" ? "PROMO " : ""}${item.nombre}</td>
                        <td>S/ ${subtotal.toFixed(2)}</td>
                        <td><button class="btn btn-danger btn-sm py-0" onclick="eliminarDelCarrito(${item.id}, '${item.tipo}')">×</button></td>
                    </tr>`;
            });
            totalSpan.innerHTML = "S/ " + total.toFixed(2);
        }

        // --- 3. FUNCIONES DEL MODAL DE PAGO ---

        function abrirModalPago() {
            // Verificar carrito vacío
            if (compras.length === 0) {
                Swal.fire('Carrito vacío', 'Agrega platos antes de pagar.', 'info');
                return;
            }

            // Verificar si ya tiene pedido activo
            if (sessionStorage.getItem("ventaActual")) {
                 Swal.fire({
                    title: '¡Pedido en curso!',
                    text: 'Ya tienes un pedido pendiente. Debes esperar a que finalice.',
                    icon: 'warning',
                    confirmButtonText: 'Ver estado'
                }).then((result) => {
                    if (result.isConfirmed) window.location.href = "@Url.Action("Estado", "Home")";
                });
                return;
            }

            // Llenar datos del Modal
            const tbody = document.getElementById("tablaConfirmarPago");
            tbody.innerHTML = "";
            let total = 0;

            compras.forEach(item => {
                let costo = 0;

                // CORRECCIÓN VISUAL:
                if (item.promocion != null) {
                    // Si es promo, el precio ya es neto, multiplicar directo
                    costo = item.precio * item.cantidad;
                } else {
                    // Si es plato, aplicar descuento si hubiera
                    costo = item.precio * item.cantidad * (1 - (item.descuento || 0));
                }

                total += costo;

                tbody.innerHTML += `
            <tr>
                <td class="text-muted">${item.cantidad} x ${item.nombre}</td>
                <td class="text-end fw-bold">S/ ${costo.toFixed(2)}</td>
            </tr>`;
            });

            document.getElementById("CostototalPagoModal").innerText = "S/ " + total.toFixed(2);
            document.getElementById("btnTotalLabel").innerText = "(S/ " + total.toFixed(2) + ")";

            // Abrir Modal con Bootstrap
            var myModal = new bootstrap.Modal(document.getElementById('modalPago'));
            myModal.show();
        }

        function validarYPagar() {
            // Validaciones Visuales
            const banco = document.getElementById("selectTipoTarjeta").value;
            const tarjeta = document.getElementById("txtNrtarjeta").value;
            const cvv = document.getElementById("txtCVV").value;
            const venc = document.getElementById("txtFechaVenc").value;

            if (banco === "") return Swal.fire('Falta Banco', 'Seleccione su banco.', 'warning');
            if (tarjeta.length < 16) return Swal.fire('Tarjeta Inválida', 'Revise el número de tarjeta.', 'warning');
            if (venc === "" || cvv === "") return Swal.fire('Datos Incompletos', 'Complete fecha y CVV.', 'warning');

            // Cerrar Modal
            const modalEl = document.getElementById('modalPago');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // Ejecutar el envío al servidor
            enviarVentaAlServidor();
        }

        // --- 4. AJAX (ENVÍO AL SERVIDOR) ---

        function enviarVentaAlServidor() {
            let detalle = compras.map(x => ({
                Id_Plato: x.id,
                Precio_Unitario: x.precio,
                Cantidad: x.cantidad,
                Descuento: x.descuento,
                Id_Promocion: x.promocion
            }));
            // CAPTURAR DATOS DEL FORMULARIO
            let banco = document.getElementById("selectTipoTarjeta").value;
            let tarjeta = document.getElementById("txtNrtarjeta").value.replace(/\s/g, ''); // Quitar espacios
            let fecha = document.getElementById("txtFechaVenc").value;
            let cvv = document.getElementById("txtCVV").value;

            Swal.fire({ title: 'Procesando pago...', didOpen: () => Swal.showLoading() });

            $.ajax({
                url: "/Ventas/RegistrarVenta",
                method: "POST",
                data: {
                    json: JSON.stringify(detalle),
                    banco: banco,
                    tarjeta: tarjeta,
                    fecha: fecha,
                    cvv: cvv
                },
                success: function (r) {
                    if (r.ok) {
                        // PAGO EXITOSO
                        sessionStorage.setItem("ventaActual", r.idVenta);
                        compras = [];
                        sessionStorage.removeItem("carrito");
                        actualizarTabla();

                        Swal.fire({
                            title: '¡Pago Exitoso!',
                            text: 'Tu orden ha sido pagada y registrada.',
                            icon: 'success',
                            confirmButtonText: 'Ver estado'
                        }).then(() => {
                            window.location.href = "@Url.Action("Estado", "Home")";
                        });
                    } else {
                        // ERROR DE PAGO (Saldo insuficiente, etc.)
                        Swal.fire('Pago Rechazado', r.error, 'error');
                    }
                },
                error: function (xhr) {
                    Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error');
                }
            });
        }

        // Formato automático de tarjeta (UX)
        document.getElementById('txtNrtarjeta').addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/\D/g, '').replace(/(\d{4})(?=\d)/g, '$1 ').trim();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    @RenderSection("scripts", required: false)
</body>
</html>