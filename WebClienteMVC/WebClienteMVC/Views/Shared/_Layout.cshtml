@{
    Layout = null;
    // Recuperamos el nombre, si es nulo será "Invitado"
    string usuarioNombre = Session["Usuario"]?.ToString() ?? "Invitado";
    // Variable auxiliar para saber si está logueado
    bool isLogged = usuarioNombre != "Invitado";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewBag.Title - La Mamacha</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
        }

        /* CABECERA */
        .header-food {
            background-image: url('/Recursos/Inicio.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 15px 10px;
            border-bottom: 3px solid #000;
        }

        .text-border {
            text-shadow: -1px -1px 0 black, 1px -1px 0 black, -1px 1px 0 black, 1px 1px 0 black;
        }

        .menu-food a {
            color: white;
            font-weight: bold;
            font-size: 22px;
            text-decoration: none;
        }

            .menu-food a:hover {
                color: yellow;
            }

        /* ESTILO PARA EL DROPDOWN DEL USUARIO */
        .user-dropdown-toggle {
            cursor: pointer;
            text-decoration: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

            .user-dropdown-toggle:hover {
                opacity: 0.9;
            }

        /* PANEL IZQUIERDO */
        #panelCompras {
            background: #f7f7f7;
            border-right: 3px solid #ccc;
            min-height: calc(100vh - 260px);
            overflow-y: auto;
            transition: width 0.35s ease;
            width: 400px;
            max-width: 400px;
            min-width: 55px;
        }

        .panel-collapsed {
            width: 55px !important;
            max-width: 60px !important;
            overflow: hidden;
        }

        .table-hidden, .titulo-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .toggle-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 20;
        }

        /* CONTENIDO PRINCIPAL */
        .main-content {
            min-height: calc(100vh - 260px);
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 250px);
            padding-right: 10px;
        }

        /* FOOTER */
        .footer-food {
            background-image: url('/Recursos/Inicio.jpg');
            background-size: cover;
            text-align: center;
            padding: 23px 0;
            border-top: 3px solid #000;
        }

            .footer-food h1 {
                color: white;
                font-size: 40px;
                font-weight: bold;
                text-shadow: -1px -1px 0 black, 1px -1px 0 black, -1px 1px 0 black, 1px 1px 0 black;
            }
    </style>

</head>
<body>

    <div class="container-fluid header-food">
        <div class="row text-center align-items-center">

            <div class="col-12 col-md-2">
                <img src="~/Recursos/fondo_web.png" class="img-fluid" style="max-height: 110px;" />
            </div>

            <div class="col-12 col-md-8">
                <h1 class="text-border fw-bold">La Mamacha</h1>

                <div class="row menu-food mt-3">
                    <div class="col">@Html.ActionLink("Plato", "Platos", "Home")</div>
                    <div class="col">@Html.ActionLink("Promociones", "Promociones", "Home")</div>
                    <div class="col">@Html.ActionLink("Estado", "Estado", "Home")</div>
                </div>
            </div>

            <div class="col-12 col-md-2 d-flex justify-content-center justify-content-md-end pe-md-4">

                <div class="dropdown">
                    <div class="user-dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="text-end me-2">
                            <h4 class="text-border m-0">@usuarioNombre</h4>
                            <small class="text-white">@(isLogged ? "Online" : "Bienvenido")</small>
                        </div>
                        <img src="/Recursos/Usuario.png" class="img-fluid rounded-circle border border-2 border-white" style="max-height: 60px; width: 60px; object-fit: cover;" />
                    </div>

                    <ul class="dropdown-menu dropdown-menu-end shadow">
                        @if (isLogged)
                        {
                            <li><h6 class="dropdown-header">Hola, @usuarioNombre</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger fw-bold" href="@Url.Action("Login", "Login")">Cerrar Sesión</a></li>
                        }
                        else
                        {
                            <li><a class="dropdown-item fw-bold" href="@Url.Action("Login", "Usuarios")">Iniciar Sesión</a></li>
                            <li><a class="dropdown-item" href="@Url.Action("Registro", "Usuarios")">Registrarse</a></li>
                        }
                    </ul>
                </div>

            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row gx-0 d-flex">

            <div id="panelCompras" class="col-auto position-relative">

                <div id="tituloCompras" class="p-2">
                    <h4 class="fw-bold m-0">Compras</h4>
                </div>

                <button id="btnTogglePanel" class="btn btn-warning toggle-btn">☰</button>

                <div class="compras-table p-2">
                    <table class="table table-bordered tabla-compras">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Plato</th>
                                <th>Precio</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCompras">
                        </tbody>
                    </table>
                    <h4 class="text-end fw-bold mt-2">
                        Total: <span id="totalCompras">S/ 0.00</span>
                    </h4>
                    <button class="btn btn-success w-100 mt-2 fw-bold"
                            onclick="confirmarVenta()">
                        Realizar Pedido
                    </button>
                </div>
            </div>

            <div class="col main-content flex-grow-1">
                @RenderBody()
            </div>

        </div>
    </div>

    <div class="footer-food">
        <h1>Date un gustito, te lo mereces</h1>
    </div>

    <script>
        // ==========================================
        // 1. LÓGICA DEL PANEL LATERAL
        // ==========================================
        const panel = document.getElementById("panelCompras");
        const tabla = document.querySelector(".compras-table");
        const titulo = document.getElementById("tituloCompras");
        const btn = document.getElementById("btnTogglePanel");

        let oculto = false;

        function aplicarResponsive() {
            if (window.innerWidth < 768) {
                panel.classList.add("panel-collapsed");
                tabla.classList.add("table-hidden");
                titulo.classList.add("titulo-hidden");
                btn.classList.add("toggle-floating");
                oculto = true;
            } else {
                panel.classList.remove("panel-collapsed");
                tabla.classList.remove("table-hidden");
                titulo.classList.remove("titulo-hidden");
                oculto = false;
            }
        }

        window.addEventListener("resize", aplicarResponsive);
        aplicarResponsive(); // Ejecutar al inicio

        btn.addEventListener("click", () => {
            oculto = !oculto;
            if (oculto) {
                panel.classList.add("panel-collapsed");
                tabla.classList.add("table-hidden");
                titulo.classList.add("titulo-hidden");
                btn.classList.add("toggle-floating");
            } else {
                panel.classList.remove("panel-collapsed");
                tabla.classList.remove("table-hidden");
                titulo.classList.remove("titulo-hidden");
                btn.classList.remove("toggle-floating");
            }
        });

        // ==========================================
        // 2. LÓGICA DEL CARRITO DE COMPRAS
        // ==========================================
        let compras = [];

        // Cargar carrito guardado
        if (sessionStorage.getItem("carrito")) {
            compras = JSON.parse(sessionStorage.getItem("carrito"));
            actualizarTabla();
        }

        function guardarCarrito() {
            sessionStorage.setItem("carrito", JSON.stringify(compras));
        }

        function agregarACompras(id, nombre, precio, cantidad = 1) {
            let existe = compras.find(x => x.id === id && x.tipo === "plato");
            if (existe) {
                existe.cantidad += cantidad;
            } else {
                compras.push({
                    id: id, nombre: nombre, precio: precio, cantidad: cantidad,
                    descuento: null, promocion: null, tipo: "plato"
                });
            }
            guardarCarrito();
            actualizarTabla();

            // Feedback visual pequeño
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 1500
            });
            Toast.fire({ icon: 'success', title: 'Agregado al carrito' });
        }

        function agregarAComprasPromo(idPlato, nombre, descuento, precio, cant, idpromo) {
            let existe = compras.find(x => x.id === idPlato && x.tipo === "promo");
            if (existe) {
                existe.cantidad += 1;
            } else {
                compras.push({
                    id: idPlato, nombre: nombre, precio: precio, cantidad: cant,
                    descuento: descuento, promocion: idpromo, tipo: "promo"
                });
            }
            guardarCarrito();
            actualizarTabla();

            Swal.fire({
                icon: 'success', title: '¡Promoción agregada!', showConfirmButton: false, timer: 1500
            });
        }

        function eliminarDelCarrito(id, tipo) {
            compras = compras.filter(p => !(p.id === id && p.tipo === tipo));
            guardarCarrito();
            actualizarTabla();
        }

        function actualizarTabla() {
            let tablaBody = document.getElementById("tablaCompras");
            let totalSpan = document.getElementById("totalCompras");

            if(!tablaBody || !totalSpan) return; // Evita errores si no encuentra la tabla

            tablaBody.innerHTML = "";
            let total = 0;

            compras.forEach(item => {
                let subtotal = item.precio * item.cantidad;
                total += subtotal;
                tablaBody.innerHTML += `
                    <tr>
                        <td>${item.cantidad}</td>
                        <td style="font-size:0.9em;">${item.tipo === "promo" ? "PROMO " : ""}${item.nombre}</td>
                        <td>S/ ${subtotal.toFixed(2)}</td>
                        <td><button class="btn btn-danger btn-sm py-0" onclick="eliminarDelCarrito(${item.id}, '${item.tipo}')">×</button></td>
                    </tr>`;
            });
            totalSpan.innerHTML = "S/ " + total.toFixed(2);
        }

        // ==========================================
        // 3. CONFIRMAR VENTA (Aquí estaba el posible error)
        // ==========================================
        function confirmarVenta() {
            // A. Verificar si ya tiene un pedido activo (Bloqueo)
            if (sessionStorage.getItem("ventaActual")) {
                Swal.fire({
                    title: '¡Pedido en curso!',
                    text: 'Ya tienes un pedido pendiente. Debes esperar a que finalice.',
                    icon: 'warning',
                    confirmButtonText: 'Ver estado'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = "@Url.Action("Estado", "Home")";
                    }
                });
                return; // IMPORTANTE: Detiene la función aquí
            }

            // B. Verificar carrito vacío
            if (compras.length === 0) {
                Swal.fire('Carrito vacío', 'Agrega algún plato antes de pedir.', 'info');
                return;
            }

            // C. Preparar datos
            let detalle = compras.map(x => ({
                Id_Plato: x.id,
                Precio_Unitario: x.precio,
                Cantidad: x.cantidad,
                Descuento: x.descuento,
                Id_Promocion: x.promocion
            }));

            // D. Enviar al servidor
            $.ajax({
                url: "/Ventas/RegistrarVenta",
                method: "POST",
                data: { json: JSON.stringify(detalle) },
                success: function (r) {
                    if (r.ok) {
                        // 1. Guardar ID venta para bloquear futuros pedidos
                        sessionStorage.setItem("ventaActual", r.idVenta);

                        // 2. Limpiar carrito
                        compras = [];
                        sessionStorage.removeItem("carrito");
                        actualizarTabla();

                        // 3. Alerta de Éxito y Redirección
                        Swal.fire({
                            title: '¡Pedido Enviado!',
                            text: 'Tu orden se ha registrado correctamente.',
                            icon: 'success',
                            confirmButtonText: 'Ver estado del pedido'
                        }).then(() => {
                            window.location.href = "@Url.Action("Estado", "Home")";
                        });

                    } else {
                        Swal.fire('Error', 'El servidor respondió: ' + r.error, 'error');
                    }
                },
                error: function (xhr) {
                    console.error(xhr);
                    Swal.fire('Error de conexión', 'No se pudo conectar con el servidor. Verifica tu sesión.', 'error');
                }
            });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    @RenderSection("scripts", required: false)
</body>
</html>